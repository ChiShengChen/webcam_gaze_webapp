<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Webcam Gaze Tracker</title>
  </head>
  <body>
    <!-- Mode Toggle -->
    <div id="mode-toggle">
      <button id="tracker-mode-btn" class="mode-btn active">Gaze Tracker</button>
      <button id="label-mode-btn" class="mode-btn">Label Mode</button>
      <button id="video-mode-btn" class="mode-btn">Video Mode</button>
    </div>

    <!-- Gaze Tracker Mode -->
    <div id="tracker-mode" class="mode-container">
      <div class="container">
        <h1>Webcam Gaze Tracker</h1>
        <p>This application uses your webcam to track your gaze. Please follow the steps below.</p>
        
        <div id="calibration-instructions">
          <h2>Calibration</h2>
          <p>Please click on each of the circles on the screen. Do this a few times until the red dot follows your gaze. You can click the button below to start over.</p>
          <button id="start-calibration">Start Calibration</button>
        </div>

        <div id="gaze-dot"></div>
        
        <!-- Heatmap Container -->
        <div id="heatmap-container">
          <div id="heatmap-header">
            <span>Gaze Heatmap</span>
            <button id="toggle-heatmap">Hide</button>
            <button id="clear-heatmap">Clear</button>
          </div>
          <canvas id="heatmap-canvas"></canvas>
        </div>
        
        <div id="calibration-dots">
          <div class="calibration-dot" style="top: 5%; left: 5%;"></div>
          <div class="calibration-dot" style="top: 5%; left: 50%;"></div>
          <div class="calibration-dot" style="top: 5%; left: 95%;"></div>
          <div class="calibration-dot" style="top: 50%; left: 5%;"></div>
          <div class="calibration-dot" style="top: 50%; left: 50%;"></div>
          <div class="calibration-dot" style="top: 50%; left: 95%;"></div>
          <div class="calibration-dot" style="top: 95%; left: 5%;"></div>
          <div class="calibration-dot" style="top: 95%; left: 50%;"></div>
          <div class="calibration-dot" style="top: 95%; left: 95%;"></div>
        </div>
      </div>
    </div>

    <!-- Label Mode -->
    <div id="label-mode" class="mode-container" style="display: none;">
      <div class="label-container">
        <!-- Left Panel: Controls -->
        <div id="label-controls">
          <h2>Gaze Label Tool</h2>
          
          <div class="control-section">
            <h3>1. Load Image</h3>
            <input type="file" id="image-upload" accept="image/*" />
            <div id="image-list"></div>
          </div>
          
          <div class="control-section">
            <h3>2. Labels</h3>
            <div id="label-input-group">
              <input type="text" id="label-name-input" placeholder="Enter label name" />
              <input type="color" id="label-color-input" value="#FF6B6B" title="Choose label color" />
              <button id="add-label-btn">Add</button>
            </div>
            <div id="current-label-display">
              <span>Current: </span>
              <span id="current-label-name">None</span>
              <button id="deselect-label-btn" disabled>Deselect</button>
            </div>
            <div id="label-list"></div>
          </div>
          
          <div class="control-section">
            <h3>3. Gaze Control</h3>
            <p class="hint">Look at an object and press <kbd>Space</kbd> to segment</p>
            <div id="gaze-status">
              <span id="gaze-coords">Gaze: (-, -)</span>
            </div>
            <button id="undo-segment-btn" disabled>Undo Last Segment</button>
          </div>
          
          <div class="control-section">
            <h3>4. Annotations</h3>
            <div id="annotation-list"></div>
          </div>
          
          <div class="control-section">
            <h3>5. Export</h3>
            <button id="export-coco-btn">Export COCO JSON</button>
            <button id="export-yolo-btn">Export YOLO TXT</button>
          </div>
          
          <div class="control-section">
            <h3>Model Status</h3>
            <div id="model-status">Loading SAM model...</div>
          </div>
        </div>
        
        <!-- Right Panel: Image Canvas -->
        <div id="label-workspace">
          <div id="canvas-container">
            <canvas id="image-canvas"></canvas>
            <canvas id="mask-canvas"></canvas>
            <div id="gaze-cursor"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Mode -->
    <div id="video-mode" class="mode-container" style="display: none;">
      <div class="video-container">
        <!-- Left Panel: Controls -->
        <div id="video-controls">
          <h2>Video Annotation Tool</h2>
          
          <div class="control-section">
            <h3>1. Load Video</h3>
            <input type="file" id="video-upload" accept="video/*" />
            <div id="video-info"></div>
          </div>
          
          <div class="control-section">
            <h3>2. Audio Recording</h3>
            <div id="audio-status">
              <span id="mic-status">Microphone: Not connected</span>
            </div>
            <button id="connect-mic-btn">Connect Microphone</button>
            <div id="audio-visualizer">
              <canvas id="audio-level-canvas"></canvas>
            </div>
          </div>
          
          <div class="control-section">
            <h3>3. Recording Controls</h3>
            <p class="hint">Play video to start recording gaze + audio</p>
            <div id="recording-status">
              <span id="record-indicator">● Ready</span>
              <span id="record-time">00:00:00</span>
            </div>
            <div id="video-playback-controls">
              <button id="video-play-btn" disabled>▶ Play & Record</button>
              <button id="video-pause-btn" disabled>⏸ Pause</button>
              <button id="video-stop-btn" disabled>⏹ Stop</button>
            </div>
          </div>
          
          <div class="control-section">
            <h3>4. Gaze Tracking</h3>
            <div id="video-gaze-status">
              <span id="video-gaze-coords">Gaze: (-, -)</span>
              <span id="video-frame-info">Frame: -</span>
            </div>
            <div id="gaze-point-count">Points recorded: 0</div>
          </div>
          
          <div class="control-section">
            <h3>5. Export</h3>
            <button id="export-video-annotation-btn" disabled>Export Annotation (JSON)</button>
            <button id="export-video-audio-btn" disabled>Export Audio (WebM)</button>
            <button id="export-video-all-btn" disabled>Export All (ZIP)</button>
          </div>
          
          <div class="control-section">
            <h3>6. Areas of Interest (AOI)</h3>
            <div id="aoi-input-group">
              <input type="text" id="aoi-name-input" placeholder="AOI name" />
              <input type="color" id="aoi-color-input" value="#FF6B6B" title="AOI color" />
            </div>
            <div id="aoi-draw-controls">
              <button id="draw-aoi-btn" disabled>Draw Rectangle</button>
              <button id="cancel-aoi-btn" style="display: none;">Cancel</button>
            </div>
            <div id="aoi-list"></div>
          </div>
          
          <div class="control-section">
            <h3>7. Analysis</h3>
            <div id="analysis-params">
              <label>
                <span>Dispersion threshold:</span>
                <input type="number" id="dispersion-threshold" value="0.03" min="0.01" max="0.1" step="0.01" />
              </label>
              <label>
                <span>Min fixation (ms):</span>
                <input type="number" id="min-fixation-duration" value="100" min="50" max="500" step="10" />
              </label>
            </div>
            <button id="run-analysis-btn" disabled>Run Analysis</button>
            <button id="toggle-scanpath-btn" disabled>Show Scanpath</button>
            <div id="analysis-results" style="display: none;">
              <div id="fixation-summary"></div>
              <details id="dwell-time-section">
                <summary>Dwell Time Statistics</summary>
                <div id="dwell-time-table"></div>
              </details>
              <details id="first-fixation-section">
                <summary>First Fixation Metrics</summary>
                <div id="first-fixation-table"></div>
              </details>
              <details id="scanpath-section">
                <summary>Scanpath Metrics</summary>
                <div id="scanpath-metrics"></div>
              </details>
            </div>
            <button id="export-analysis-btn" disabled>Export Analysis (CSV)</button>
          </div>
          
          <div class="control-section">
            <h3>Session Info</h3>
            <div id="session-info">
              <div>Video: <span id="session-video-name">-</span></div>
              <div>Duration: <span id="session-duration">-</span></div>
              <div>Gaze points: <span id="session-gaze-count">0</span></div>
              <div>Audio: <span id="session-audio-status">Not recorded</span></div>
            </div>
          </div>
        </div>
        
        <!-- Right Panel: Video Player -->
        <div id="video-workspace">
          <div id="video-player-container">
            <video id="annotation-video" crossorigin="anonymous"></video>
            <canvas id="video-gaze-overlay"></canvas>
            <div id="video-gaze-cursor"></div>
          </div>
          <div id="video-timeline">
            <canvas id="timeline-canvas"></canvas>
            <div id="timeline-markers"></div>
          </div>
        </div>
      </div>
    </div>

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
